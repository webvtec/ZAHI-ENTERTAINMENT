<!DOCTYPE html>

<html lang="en">
<head>
<!-- Essential for correct scaling on mobile -->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>ADMIN DASHBOARD</title>
<link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&amp;display=swap" rel="stylesheet"/>
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
    html, body {
      width: 100%;
      min-width: 0;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
      font-family: 'Zilla Slab', serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .header-bar {
      background: #FFD1DC;
      padding: 16px 0;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: #6200ea;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      border: none;
    }

    .top-menu {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      background: #6200ea;
      padding: 10px 0;
      width: 100%;
      box-sizing: border-box;
      margin: 0;
      border: none;
    }

    .top-menu button {
      flex: 1;
      margin: 5px;
      padding: 12px;
      border: none;
      border-radius: 5px;
      background: #fff;
      color: #6200ea;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      min-width: 120px;
      transition: background 0.2s;
    }

    .top-menu button:hover {
      background: #FFD1DC;
    }

    @media (max-width: 1200px) {
  .top-menu {
    flex-direction: column;
    align-items: center;  /* center buttons */
  }
  .top-menu button {
    width: 90%;          /* not full width */
    max-width: 300px;    /* shorter size */
    min-width: unset;
  }
}

    .admin-container {
      width: 100%;
      max-width: 1100px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.09);
      box-sizing: border-box;
      overflow-x: auto;
    }

    h2 {
      color: #6200ea;
      text-align: center;
    }

    input[type="text"], input[type="date"], input[type="time"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    button {
      background: #6200ea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 1rem;
      font-family: inherit;
    }
    button:hover {
      background: #3700b3;
    }

    .gallery-category {
      margin-top: 40px;
      width: 100%;
    }
    .gallery-category h3 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
      color: #6200ea;
      text-transform: uppercase;
    }

    .gallery-wrapper {
      width: 100%;
      margin: 0 auto;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 30px;
      width: 100%;
    }

    @media (max-width: 1000px) {
      .gallery-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .product-slot {
      display: flex;
      flex-direction: column;
      padding: 15px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.09);
      width: 100%;
      box-sizing: border-box;
    }
    .product-slot input, .product-slot select {
      margin-bottom: 8px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .product-slot button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .product-slot img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      margin-bottom: 8px;
      border-radius: 6px;
      background: #eee;
      border: 1px solid #eee;
    }

    .card-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .delete-btn {
  background: #dc3545;   /* red */
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.delete-btn:hover {
  background: #a71d2a;   /* darker red on hover */
}

.save-btn {
  background: #28a745;   /* green */
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
.save-btn:hover {
  background: #1e7e34;   /* darker green on hover */
}


    .gallery-grid div {
      position: relative;
    }
    .gallery-grid img {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }
    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: red;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #6200ea;
      color: white;
    }
    .content-section {
      display: none;
      width: 100%;
    }
    .content-section.active {
      display: block;
      width: 100%;
    }
    .clear-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .clear-container input {
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .add-slot-container {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.add-slot-btn {
  background: #28a745;   /* green like Save */
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}
.add-slot-btn:hover {
  background: #1e7e34;   /* darker green on hover */
}

    .product-slot textarea {
  margin-bottom: 8px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  resize: vertical;         /* user can resize down/up */
  font-family: inherit;     /* match rest of inputs */
  font-size: 14px;
}

.reservation-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  padding: 15px;
  margin: 12px 0;
}

.reservation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.reservation-header h3 {
  margin: 0;
  color: #6200ea;
}

.badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
  color: #fff;
}
.badge.today { background: #28a745; }     /* green */
.badge.upcoming { background: #ff9800; }  /* orange */

    .reservation-group {
  margin-top: 30px;
  margin-bottom: 10px;
  padding: 8px 14px;
  background: #6200ea;
  color: #fff;
  border-radius: 6px;
  font-size: 1.1rem;
  text-align: center;
}

    .badge.past {
  background: #9e9e9e; /* grey */
  color: white;
}

    .badge.tomorrow {
  background: #007bff; /* blue */
  color: white;
}

.highlighted {
  border: 3px solid #ff9800 !important;
  box-shadow: 0 0 12px #ff9800 !important;
  transition: all 0.3s ease-in-out;
}


.reservation-card .action-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  gap: 10px;
}

.reservation-card .action-buttons button {
  flex: 1;
  padding: 10px;
  font-weight: bold;
  border-radius: 6px;
}

    .cancel-btn, .invoice-btn {
  flex: 1;
  padding: 12px 14px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background 0.2s;
}

/* keep unique colors */
.cancel-btn {
  background-color: #e53935;
  color: white;
}
.cancel-btn:hover {
  background-color: #c62828;
}

.invoice-btn {
  background-color: #28a745;
  color: white;
}
.invoice-btn:hover {
  background-color: #1e7e34;
}

</style>
</head>
<body>
<div class="header-bar">ADMIN DASHBOARD</div>
<div class="top-menu">
<button onclick="showSection('gallerySection')">GALLERY</button>
<button onclick="showSection('reservationsPage')">RESERVATIONS</button>
<button onclick="showSection('unavailableDaysSection')">UNAVAILABLE DAYS</button>
</div>
<!-- Gallery Management Page -->
<div class="admin-container content-section" id="gallerySection">
<div class="add-slot-container">
<button class="add-slot-btn" onclick="addNewSlot()">âž• Add New Slot</button>
</div>
<div id="adminGallery"></div>
</div>
<!-- Reservations Section -->
<div class="admin-container content-section" id="reservationsPage">
<h2>Reservations</h2>
<div style="display:flex; gap:10px; margin-bottom:15px;"><input id="reservationSearch" placeholder="SEARCH ORDERS..." type="text"/><button onclick="searchReservations()">Search</button></div><div id="reservationsList"></div>
<div class="clear-container">
<input id="clearInput" placeholder='Type "CONFIRM" to clear past reservations' type="text"/>
<button onclick="clearReservations()">Clear Past Reservations</button>
</div>
</div>
<!-- Unavailable Days Page -->
<div class="admin-container content-section" id="unavailableDaysSection">
<h2>Set Unavailable Days</h2>
<input id="unavailableDateInput" type="date"/>
<label><input checked="" id="allDayCheckbox" onchange="toggleTimeInputs()" type="checkbox"/> All Day</label>
<div id="timeInputs" style="display: none;">
<label>FROM:</label>
<input id="startTimeInput" type="time"/>
<label>UNTIL:</label>
<input id="endTimeInput" type="time"/>
</div>
<button onclick="addUnavailableDate()">Add Unavailable Date</button>
<h3>Unavailable Dates</h3>
<ul id="unavailableDatesList"></ul>
</div>
<!-- Invoice Modal -->
<div id="invoiceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
 background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
<div style="background:#fff; padding:20px; border-radius:10px; width:300px;">
<h3>Select Payment Options</h3>
<label><input type="checkbox" value="ONE TIME FULL BANK TRANSFER"/> ONE TIME FULL BANK TRANSFER</label><br/>
<label><input type="checkbox" value="FULL PAYMENT UPON ARRIVAL"/> FULL PAYMENT UPON ARRIVAL</label><br/>
<label><input type="checkbox" value="50% BANK TRANSFER"/> 50% BANK TRANSFER</label><br/>
<label><input type="checkbox" value="50% UPON ARRIVAL"/> 50% UPON ARRIVAL</label><br/><br/>
<button onclick="closeInvoiceModal()">Cancel</button>
<button onclick="sendInvoice()">Send</button>
</div>
</div>
<script>
    const firebaseConfig = {
  apiKey: "AIzaSyD7424mubtMpjSmRUG5eonaVxGaRrpKs-s",
  authDomain: "tttnail-care-walkin-pay.firebaseapp.com",
  projectId: "tttnail-care-walkin-pay",
  storageBucket: "tttnail-care-walkin-pay.firebasestorage.app",
  messagingSenderId: "841515431051",
  appId: "1:841515431051:web:f73dfab462d7b152c8508e"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function showSection(sectionId) {
      document.querySelectorAll('.content-section').forEach(section =>
        section.classList.remove('active')
      );
      document.getElementById(sectionId).classList.add('active');
    }

    function toggleTimeInputs() {
      const isAllDay = document.getElementById('allDayCheckbox').checked;
      document.getElementById('timeInputs').style.display = isAllDay ? 'none' : 'block';
    }

    function addPhotoUrl() {
  const nameInput = document.getElementById('itemNameInput');
  const urlInput = document.getElementById('photoUrlInput');
  const priceInput = document.getElementById('itemPriceInput'); // add this line
  const categorySelect = document.getElementById('photoCategorySelect');

  const name = nameInput.value.trim();
  const url = urlInput.value.trim();
  const price = parseFloat(priceInput.value); // add this line
  const category = categorySelect.value.trim();

  // Validate all fields
  if (name === '' || url === '' || isNaN(price) || category === '') {
    alert('Please enter a name, valid image URL, price, and select a category.');
    return;
  }

  // Save to Firebase (âœ… add price)
  db.collection('gallery').add({
    name: name,
    url: url,
    price: price,
    category: category
  })
  .then(() => {
    nameInput.value = '';
    urlInput.value = '';
    priceInput.value = ''; // clear price input
    categorySelect.value = '';
    alert('Item added successfully!');
  })
  .catch(error => {
    console.error("Error adding item: ", error);
    alert('Error adding item: ' + error.message);
  });
}

function loadGallery() {
  const galleryContainer = document.getElementById("adminGallery"); // âœ… correct container

  db.collection("gallery").onSnapshot(snapshot => {
    galleryContainer.innerHTML = "";
    const items = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      items.push({
        docId: doc.id,
        name: data.name || "",
        description: data.description || "",
        price: data.price || 0,
        imageUrl: data.imageUrl || data.url || "", // âœ… fallback for old docs
        category: (data.category || "Uncategorized").toUpperCase(),
        timestamp: data.timestamp ? (data.timestamp.toMillis?.() || data.timestamp) : 0
      });
    });

    // sort newest first
    items.sort((a, b) => a.timestamp - b.timestamp);

    // group by category
    const categories = {};
    items.forEach(item => {
      if (!categories[item.category]) {
        categories[item.category] = [];
      }
      categories[item.category].push(item);
    });

    // render each category block
    Object.keys(categories).forEach(category => {
      const categoryContainer = document.createElement("div");
      categoryContainer.className = "gallery-category";
      categoryContainer.innerHTML = `<h2>${category}</h2>`;

      categories[category].forEach(item => {
        categoryContainer.innerHTML += `
  <div class="product-slot" id="${item.docId}">
    <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="Product">
    <textarea id="name-${item.docId}" placeholder="Item Name" rows="2">${item.name}</textarea>
    <textarea id="desc-${item.docId}" placeholder="Item Description" rows="3">${item.description}</textarea>
    <input type="number" id="price-${item.docId}" value="${item.price}" placeholder="Price">
    <input type="text" id="url-${item.docId}" value="${item.imageUrl}" placeholder="Image URL">
    <select id="category-${item.docId}">
      <option value="EVENT ITEMS" ${item.category==="EVENT ITEMS"?"selected":""}>EVENT ITEMS</option>
      <option value="THRILL RIDES" ${item.category==="THRILL RIDES"?"selected":""}>THRILL RIDES</option>
      <option value="CARS" ${item.category==="CARS"?"selected":""}>CARS</option>
      <option value="BATHROOM" ${item.category==="BATHROOM"?"selected":""}>BATHROOM</option>
    </select>
    <div class="card-buttons">
      <button class="delete-btn" onclick="removePhoto('${item.docId}')">ðŸ—‘ Delete</button>
      <button class="save-btn" onclick="updateProduct('${item.docId}')">ðŸ’¾ Save</button>
    </div>
  </div>
`;
      });

      galleryContainer.appendChild(categoryContainer);
    });
  });
}



    function removePhoto(docId) {
      db.collection('gallery').doc(docId).delete().catch((error) => {
        console.error("Error removing document: ", error);
        alert('Error removing photo: ' + error.message);
      });
    }

    function addNewSlot() {
      const galleryContainer = document.getElementById("adminGallery");
      const newId = "new-" + Date.now();

      galleryContainer.innerHTML += `
        <div class="product-slot" id="${newId}">
          <img src="" alt="Product">
          <textarea id="name-${newId}" placeholder="Item Name" rows="2"></textarea>\n<textarea id="desc-${newId}" placeholder="Item Description" rows="3"></textarea>
          <input type="number" id="price-${newId}" placeholder="Price">
          <input type="text" id="url-${newId}" placeholder="Image URL">
          <select id="category-${newId}">
            <option value="EVENT ITEMS">EVENT ITEMS</option>
          </select>
          <div class="card-buttons">
            <button class="delete-btn" onclick="document.getElementById('${newId}').remove()">ðŸ—‘ Delete</button>
            <button class="save-btn" onclick="saveNewProduct('${newId}')">ðŸ’¾ Save</button>
          </div>
        </div>
      `;
    }
    

function saveNewProduct(docId) {
  const name = document.getElementById(`name-${docId}`).value.trim();
  const description = document.getElementById(`desc-${docId}`).value.trim();
  const price = parseFloat(document.getElementById(`price-${docId}`).value) || 0;
  const url = document.getElementById(`url-${docId}`).value.trim();
  const category = document.getElementById(`category-${docId}`).value;

  if (!name || !url || price <= 0) {
    alert("Please enter a valid name, image URL, and price.");
    return;
  }

  db.collection("gallery").add({
    name,
    description,
    price,
    imageUrl: url,
    category,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    console.log("New product saved successfully");
    // âŒ no need to manually remove temp slot
    // Firestore snapshot will re-render gallery with new product
  })
  .catch(error => {
    console.error("Error saving new product: ", error);
    alert("Error saving new product: " + error.message);
  });
}



    function updateProduct(docId) {
  const name = document.getElementById(`name-${docId}`).value;
  const description = document.getElementById(`desc-${docId}`).value;
  const price = parseFloat(document.getElementById(`price-${docId}`).value) || 0;
  const url = document.getElementById(`url-${docId}`).value;
  const category = document.getElementById(`category-${docId}`).value;

  db.collection("gallery").doc(docId).update({
    name: name || "",
    description: description || "",
    price: price || 0,
    imageUrl: url || "",   // âœ… consistent field name
    category: category || "UNCATEGORIZED",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    console.log("Product updated");
  }).catch(error => {
    console.error("Error updating product: ", error);
  });
}


    function removePhoto(docId) {
      db.collection('gallery').doc(docId).delete().catch((error) => {
        console.error("Error removing document: ", error);
        alert('Error removing photo: ' + error.message);
      });
    }

     

function loadReservations() {
  const reservationsContainer = document.getElementById('reservationsList');
  db.collection('reservations').onSnapshot(snapshot => {
    reservationsContainer.innerHTML = '';
    const now = new Date();

    function normalizeDate(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    const today = normalizeDate(now);

    // define tomorrow
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    function parseLocalDate(dateStr) {
      if (!dateStr) return new Date(0);
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day, 0, 0, 0);
    }

    function isDayInRange(startDate, endDate, refDay) {
      return refDay >= startDate && refDay <= endDate;
    }

    function formatDate(d) {
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateRange(start, end) {
      if (!start || !end) return "";
      if (start.getTime() === end.getTime()) return formatDate(start);
      return `${formatDate(start)} to ${formatDate(end)}`;
    }

    function formatTimeRange(startTime, endTime) {
      if (!startTime && !endTime) return "";
      function formatTime(t) {
        if (!t) return "";
        const [h, m] = t.split(':').map(Number);
        const date = new Date();
        date.setHours(h, m);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      }
      return `${formatTime(startTime)} - ${formatTime(endTime)}`;
    }

    const reservations = [];

    snapshot.forEach(doc => {
      const booking = doc.data();
      let bookingStart = null;
      let bookingEnd = null;

      if (booking.rentalDates?.includes(' to ')) {
        const [start, end] = booking.rentalDates.split(' to ');
        bookingStart = parseLocalDate(start);
        bookingEnd = parseLocalDate(end);
      } else if (booking.rentalDates) {
        bookingStart = parseLocalDate(booking.rentalDates);
        bookingEnd = bookingStart;
      }

      reservations.push({
        id: doc.id,
        bookingStart,
        bookingEnd,
        ...booking
      });
    });

    // âœ… split into groups
    const todayBookings = reservations.filter(r =>
      r.bookingStart && r.bookingEnd && isDayInRange(r.bookingStart, r.bookingEnd, today)
    );

    const tomorrowBookings = reservations.filter(r =>
      r.bookingStart && r.bookingEnd &&
      isDayInRange(r.bookingStart, r.bookingEnd, tomorrow) &&
      !isDayInRange(r.bookingStart, r.bookingEnd, today) // exclude ones already active today
    );

    const upcoming = reservations.filter(r =>
      r.bookingStart && r.bookingStart > tomorrow
    ).sort((a, b) => a.bookingStart - b.bookingStart);

    const past = reservations.filter(r =>
      r.bookingEnd && r.bookingEnd < today
    ).sort((a, b) => b.bookingEnd - a.bookingEnd);

    // helper: render a group
    function renderGroup(title, list, badgeType) {
      if (!list.length) return;
      reservationsContainer.innerHTML += `<h2 class="reservation-group">${title}</h2>`;
      list.forEach(booking => {
        const dateStr = formatDateRange(booking.bookingStart, booking.bookingEnd);
        const timeStr = formatTimeRange(booking.startTime, booking.endTime);

        const itemsList = (booking.cartItems || [])
          .map(i => `<li>${i.name} x${i.quantity}</li>`)
          .join('');

        reservationsContainer.innerHTML += `
  <div class="reservation-card" data-id="${booking.id}">
    <div class="reservation-header">
      <h3>${booking.name} (Order #${booking.orderNumber || booking.id})</h3>
      <span class="badge ${badgeType}">${title}</span>
    </div>
    <p>ðŸ“ž ${booking.phone}</p>
    <p><strong>Location:</strong> ${booking.location || 'N/A'}</p>
    <p><strong>Date:</strong> ${dateStr}</p>
    ${timeStr ? `<p><strong>Time:</strong> ${timeStr}</p>` : ''}
    <p><strong>Payment:</strong> ${booking.paymentType || ''}</p>
    <p><strong>Total:</strong> JMD $${(booking.totalAmount || 0).toLocaleString()}</p>
    <div><strong>Items:</strong><ul>${itemsList}</ul></div>
    ${booking.notes ? `<p><em>Notes: ${booking.notes}</em></p>` : ''}

    <div class="action-buttons">
      <button class="cancel-btn" onclick="cancelReservation('${booking.id}')">Cancel Order</button>
      <button class="invoice-btn" onclick="openInvoiceModal('${booking.id}')">Invoice</button>
    </div>
    ${booking.invoiceSent ? `<p class="invoice-status" style="color:green; font-weight:bold;">INVOICE SENT</p>` : ""}
  </div>`;
      });
    }

    // âœ… render in order
    renderGroup("Today", todayBookings, "today");
    renderGroup("Tomorrow", tomorrowBookings, "tomorrow");
    renderGroup("Upcoming", upcoming, "upcoming");
    renderGroup("Past", past, "past");
  });
}


    function cancelReservation(reservationId) {
  if (confirm("Are you sure you want to cancel this order?")) {
    db.collection("reservations").doc(reservationId).delete()
      .then(() => {
        alert("Order cancelled successfully.");
      })
      .catch(error => {
        console.error("Error cancelling order: ", error);
        alert("Failed to cancel order. Please try again.");
      });
  }
}


    function searchReservations() {
  const query = document.getElementById("reservationSearch").value.toLowerCase();
  const reservationsContainer = document.getElementById("reservationsList");

  // Remove old highlights
  document.querySelectorAll(".highlighted").forEach(el => el.classList.remove("highlighted"));

  if (!query) return;

  // Find first matching reservation card
  const cards = reservationsContainer.querySelectorAll(".reservation-card");
  for (let card of cards) {
    const text = card.innerText.toLowerCase();
    if (text.includes(query)) {
      card.classList.add("highlighted");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
      break;
    }
  }
}


function clearReservations() {
  const confirmInput = document.getElementById('clearInput').value.trim();
  if (confirmInput !== 'CONFIRM') { alert('TYPE "CONFIRM" TO CLEAR PAST RESERVATIONS.'); return; }

  const now = new Date();
  db.collection('reservations').get().then(snapshot => {
    const batch = db.batch();
    snapshot.forEach(doc => {
      const booking = doc.data();
      if (booking.rentalDates?.includes(' to ')) {
        const bookingDate = new Date(booking.rentalDates.split(' to ')[1]);
        if (bookingDate && now - bookingDate > 24 * 60 * 60 * 1000) {
          batch.delete(doc.ref);
        }
      }
    });
    return batch.commit();
  }).then(() => {
    alert('Past reservations cleared successfully.');
    document.getElementById('clearInput').value = '';
  });
}

function loadUnavailableDates() {
  const list = document.getElementById('unavailableDatesList');
  db.collection('unavailableDays').orderBy('date').onSnapshot(snapshot => {
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      let text = `${d.date} - ${d.allDay ? 'All Day' : `${d.startTime} to ${d.endTime}`}`;
      list.innerHTML += `<li>${text} <button onclick="removeUnavailableDate('${doc.id}')">Remove</button></li>`;
    });
  });
}

function removeUnavailableDate(id) { db.collection('unavailableDays').doc(id).delete(); }

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadGallery();   // âœ… add this
    showSection('reservationsPage');
    loadReservations();
    loadUnavailableDates();
  } else {
    window.location.href = 'index.html';
  }
});


let currentInvoiceOrderId = null;

function openInvoiceModal(orderId) {
  currentInvoiceOrderId = orderId;
  const modal = document.getElementById("invoiceModal");
  modal.style.display = "flex";

  // Clear all checkboxes first
  document.querySelectorAll("#invoiceModal input[type='checkbox']").forEach(cb => {
    cb.checked = false;
  });

  // Load saved invoice options for this order from Firestore
  db.collection("reservations").doc(orderId).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      if (data.invoiceOptions && Array.isArray(data.invoiceOptions)) {
        data.invoiceOptions.forEach(option => {
          const checkbox = [...document.querySelectorAll("#invoiceModal input[type='checkbox']")]
            .find(cb => cb.value === option);
          if (checkbox) checkbox.checked = true;
        });
      }
    }
  }).catch(err => {
    console.error("Error loading invoice options:", err);
  });
}

function closeInvoiceModal() {
  document.getElementById("invoiceModal").style.display = "none";
}

function sendInvoice() {
  const checkboxes = document.querySelectorAll("#invoiceModal input[type='checkbox']:checked");
  const selectedOptions = Array.from(checkboxes).map(cb => cb.value);

  if (selectedOptions.length === 0) {
    alert("Please select at least one option.");
    return;
  }

  db.collection("reservations").doc(currentInvoiceOrderId).update({
    invoiceOptions: selectedOptions,
    invoiceSent: true   // âœ… mark invoice as sent
  })
  .then(() => {
    closeInvoiceModal();

    // âœ… Update status message under order card
    const card = document.querySelector(`.reservation-card[data-id='${currentInvoiceOrderId}']`);
    if (card) {
      let status = card.querySelector(".invoice-status");
      if (!status) {
        status = document.createElement("p");
        status.className = "invoice-status";
        status.style.color = "green";
        status.style.fontWeight = "bold";
        card.appendChild(status);
      }
      status.innerText = "INVOICE SENT: " + selectedOptions.join(", ");
    }
  })
  .catch(err => {
    console.error("Error sending invoice:", err);
    alert("Failed to send invoice.");
  });
}

  </script>
</body>
</html>
